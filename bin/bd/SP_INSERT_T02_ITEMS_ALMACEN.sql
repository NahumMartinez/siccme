BEGIN
-- SELECCIONAMOS LOS ITEMS DE LOS PRODUCTOS EN ESTADO: 
-- ERP001(Producto Comprado), PARA QUE SE INSERTEN EN LA TABLA:
-- T02_ITEMS_ALMACEN EN ESTADO ERP009 (Producto Almacenado)
-- CAMPOS : ID_ITEM_ALMACEN, USUARIO, F_CREACION, PROGRAMA, ID_PRODUCTO,
--          ID_COMPRA, ID_ALMACEN, ID_ESTANTE, NUM_ITEM, NO_FILA, NO_COLUMNA

DECLARE FIN INT DEFAULT 0;
DECLARE VARIABLE1 INT;
DECLARE CONT INT DEFAULT 0;

DECLARE C_USUARIO, C_PROGRAMA, C_NUMCORR VARCHAR(20);
DECLARE C_FCREACION DATE;
DECLARE C_IDPRODUCTO, C_IDCOMPRA, C_IDALMACEN, C_IDESTANTE INT;
DECLARE C_NUMITEM, C_NOFILA, C_NOCOLUMNA INT; 

-- FIN DE DECLRACION DE VARIABLES ************************************************

-- CURSOR QUE INSERTARA LOS ITEMS ASOCIADOS A UN ALMACEN
  DECLARE CURSOR_1 CURSOR FOR 
  SELECT USER(), NOW(), 'T00_ITEMS_PRODUCTOS',  
         IP.ID_PRODUCTO, IP.ID_COMPRA, IP.NUM_CORRELATIVO
  FROM T00_ITEMS_PRODUCTOS IP
  WHERE IP.ID_PRODUCTO = (SELECT P.ID_PRODUCTO FROM T00_PRODUCTOS P WHERE P.COD_PRODUCTO = I_COD_PRODUCTO)
        AND IP.ID_ESTADO = 8 
  LIMIT I_LIMIT;

DECLARE CONTINUE HANDLER FOR NOT FOUND  SET  FIN = 1;

-- ABRIMOS EL CURSOR PRINCIPAL
  OPEN CURSOR_1;

-- INICIALIZAMOS EL LOOP PARA LOS INSERT
  CICLO_LOOP: LOOP 

-- SETEAMOS EL CURSOR A LAS VARIABLES
  FETCH CURSOR_1 INTO C_USUARIO, C_FCREACION, C_PROGRAMA,
                      C_IDPRODUCTO, C_IDCOMPRA, C_NUMCORR;

    IF (FIN = 1) THEN
      LEAVE CICLO_LOOP;
    END IF;

-- CONTADOR DE ITEMS A INSERTAR
    SET CONT = CONT +1;
        
    -- INSERTAMOS EN T02_ITEMS_ALMACEN
    INSERT INTO T02_ITEMS_ALMACEN (USUARIO, F_CREACION, PROGRAMA,
            ID_PRODUCTO, ID_COMPRA, ID_ALMACEN, ID_ESTANTE, NUM_ITEM, NO_FILA, NO_COLUMNA,
            ID_ESTADO, NUM_CORRELATIVO) 
    VALUES(C_USUARIO, C_FCREACION, C_PROGRAMA,
           C_IDPRODUCTO, C_IDCOMPRA, I_ID_ALMACEN, I_ID_ESTANTE,
           CONT, I_NO_FILA, I_NO_COLUMNA, 18, C_NUMCORR);
    -- ESTADO = 18 ERP009 (Producto Almacenado)
    
    -- INSERTAMOS EN LA TABLA DE HISTORICOS DE ITEMS ALMACEN
    INSERT INTO T01_HASIGNACION_ALMACENES  
        (USUARIO, F_CREACION, PROGRAMA,
         ID_PRODUCTO, ID_COMPRA, ID_ALMACEN, ID_ESTANTE,
         NUM_ITEM, NO_FILA, NO_COLUMNA, ID_ESTADO, NUM_CORRELATIVO) 
    VALUES (C_USUARIO, C_FCREACION, C_PROGRAMA, 
            C_IDPRODUCTO, C_IDCOMPRA, I_ID_ALMACEN, I_ID_ESTANTE,
            CONT, I_NO_FILA, I_NO_COLUMNA, 18, C_NUMCORR);    
    
-- ACTUALIZACION DEL STADO DE TABLA T00_ITEMS_PRODUCTOS
-- DE ITEMS EN ESTADO ERP001(Producto Comprado), INGRESADOS PREVIAMENTE EN T02_ITEMS_ALMACEN
   UPDATE T00_ITEMS_PRODUCTOS SET ID_ESTADO = 18 
   WHERE ID_PRODUCTO = C_IDPRODUCTO AND ID_COMPRA = C_IDCOMPRA AND NUM_CORRELATIVO = C_NUMCORR AND ID_ESTADO = 8;
          
-- FIN DEL CICLO LOOP    
    END LOOP CICLO_LOOP; 

-- CERRAMOS EL CURSOR
  CLOSE CURSOR_1;

-- ACTUALIZAMOS LA TABLA T00_ALMACENES, LOS ITEMS RECIEN INGRESADOS
  UPDATE T00_ALMACENES SET CANT_REAL = CANT_REAL + I_LIMIT WHERE ID_ALMACEN = I_ID_ALMACEN;

-- FIN DEL SCRIPT;
COMMIT;
END

-- PARAMETROS
-- IN I_COD_PRODUCTO 10
-- IN I_LIMIT
-- IN I_ID_ALMACEN
-- IN I_ID_ESTANTE
-- IN I_NO_FILA
-- IN I_NO_COLUMNA
